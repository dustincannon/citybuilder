<!DOCTYPE html>
<html lang="en">
  <head>
	<meta charset="utf-8">
    <title>CityBuilder</title>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/bootstrap-responsive.min.css">
	<link rel="stylesheet" href="css/custom-theme/jquery-ui-1.8.16.custom.css">
	<link rel="stylesheet" href="css/custom-theme/jquery.ui.1.8.16.ie.css">
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4/leaflet.css">
	<link rel="stylesheet" href="/css/style.css">
	<link href="/css/bootstrap-toggle-animated.css" rel="stylesheet">
  </head>
  <body>
    <div id="page" style="padding: 2em;">
		
    	<div id="map"></div>
    			<div class="question">  
    				Juvenile crime has been increasing in our beautiful city. What should we do?
  					<div class="btn-group" id="question-btn">
  						<button class='btn'>Hire more police</button>
  						<button class='btn'>Make our schools better</button>
  					</div>
				</div>  

	    		<div class="row" id="overlay">
	    		<div class="span3">
	    		<p><strong>Allow Over-budgeting?</strong></p>
	    		<div class='toggle basic' data-enabled="YES" data-disabled="NO" data-toggle="toggle">
	            <input type="checkbox" value="1" name="myCheckbox" class="checkbox" checked="checked" />
	            <label class="check" for="myCheckbox"></label>
	          	</div>
    			
				<div>
					<h2>Line Items</h2>

					<div data-budget_categories-key="a" id="slider"></div>
		      		<div id="slider-cost">Safety: <span></span></div>

					<div data-budget_categories-key="b" id="slider-1"></div>
					<div id="slider-1-cost">Infrastructure: <span></span></div>

					<div data-budget_categories-key="c" id="slider-2"></div>
					<div id="slider-2-cost">Recreation: <span></span></div>

					<div data-budget_categories-key="d" id="slider-3"></div>
					<div id="slider-3-cost">Education: <span></span></div>
				</div>

		      	<div>
					<h2>Income</h2>
					<div id="total-slider"></div>
					<div id="total-slider-cost">Income: <span></span></div>
				</div>

		      	<div>
					<h2>Totals</h2>
					<div id="total-budget-cost">Expenditures: <span></span></div>
					<div id="total-discrepancy">Discrepancy: <span></span></div>
				</div>

     		</div>
  		</div>

    </div>
    <script type="text/javascript" src="js/jquery-1.8.0.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.23.custom.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.4/leaflet.js"></script>
    <script src="js/bootstrap-toggle.js"></script>
	<script>
		var map = L.map('map').setView([35.035, -85.209], 12);
		L.tileLayer(
			'http://{s}.tile.cloudmade.com/c80639c0bd60485e919561593e8c98ee/997/256/{z}/{x}/{y}.png', 
			{
    			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
    			maxZoom: 18
			}).addTo(map);

		var polygon = 	L.polygon(
			[
				[35.060,-85.309],
				[35.072,-85.309], 
				[35.076,-85.303],
				[35.083,-85.295],
				[35.092,-85.286], 
				[35.112,-85.269], 
				[35.116,-85.260], 
				[35.119,-85.257], 
				[35.118,-85.248], 
				[35.109,-85.252], 
				[35.105,-85.235],
				[35.101,-85.251], 
				[35.098,-85.259], 
				[35.094,-85.268],
				[35.087,-85.277],
				[35.078,-85.281], 
				[35.068,-85.280],
				[35.062,-85.282], 
				[35.057,-85.292], 
				[35.060,-85.308]
			]).addTo(map).bindPopup("I'm District 2. Hooray!");

		var budget_categories = {
				a: 100,
				b: 50,
				c: 250,
				d: 150
			},
			$dependents = $('[id^=slider]').filter(':not([id$=cost])'),
			$income = $('#total-slider'),
			income = 1000,
			expenditures = 0,
			discrepancy = 0,
			allow_deficit = false;

		$dependents.each(function(){
			var $slider = $(this);
			$slider.slider({
		    	range: 'min',
				min: 1,
				max: income,
				value: budget_categories[$slider.data('budget_categories-key')],
				slide: updateLineItem,
				create: updateLineItem
			});
		});
		
		$income.slider({
			range: 'min',
			min: $dependents.length,
			max: 5000,
			value: income,
			slide: updateIncome,
			create: updateIncome
		});

		function updateLineItem( e, ui )
		{
			var $slider = $(this),
				value = ui.value || ( budget_categories[$slider.data('budget_categories-key')] || 0 );
			
			$( '#' + $slider.attr('id') + '-cost span' )
				.text( '$' + value );
			
			// check expenditures
			updateExpenditures();
			
			// check discrepencies
			updateDiscrepancy();
		}

		function updateIncome( e, ui )
		{
			income = ui.value || income;
			
			$( '#' + $income.attr('id') + '-cost span' ).text( '$' + income );
			
			updateMaxValues();

			updateDiscrepancy();
		};

		function updateExpenditures()
		{
			// recalculate expenditures
			expenditures = 0;
			$dependents.filter('.ui-slider')
				.each(function(){
					var value = $(this).slider('value');
					expenditures += value;
				});
			
			// update the field
			$('#total-budget-cost span').text( '$' + expenditures );
		}

		// Update the discrepency calculation
		function updateDiscrepancy()
		{
			// How much are we off?
			discrepancy = income - expenditures;
			
			// any reductions needed?
			if ( ! allow_deficit &&
				 discrepancy < 0 )
			{
				reduceLineItems();
			}
			
			// Surplus or deficit?
			$('#total-discrepancy span')
				.text( (discrepancy < 0 ? '-$' + Math.abs(discrepancy) : '$' + discrepancy ) )
				.removeClass('surplus deficit')
				.addClass( (discrepancy < 0 ? "deficit" : "surplus" ) );
			
			// update totals
			updateExpenditures();
		}

		// Update the Max Values of each dependent slider
		function updateMaxValues()
		{
			// set the max
			$dependents.slider( 'option','max', income );
			
			// adjust each slider to scale accordingly
			$dependents
				.each(function(){
					var $slider = $(this);
					$slider.slider( 'option', 'value', $slider.slider('value') );
				});
		}

		function reduceLineItems()
		{
			// divide equally
			var count = $dependents.length,
				reduce_by = Math.floor( discrepancy / count );
			
			while ( discrepancy < 0 )
			{
				$dependents
					.each(function(){
					
						// this only needs ot run if we still have a discrepancy
						if ( discrepancy < 0 )
						{
							var $slider = $(this),
								o_value = $slider.slider('value'),
								n_value = $slider.slider('value') + reduce_by;
            
							if ( n_value <= 0 )
							{
								n_value = 0;
								discrepancy += o_value;
							}
							else
							{
								discrepancy += Math.abs( reduce_by );
							}
            
							$slider.slider( 'option', 'value', n_value );
            
							$( '#' + $slider.attr('id') + '-cost span' )
								.text( '$' + n_value );
            
						}
					
					});
			}
		}


		$('.basic').toggle({
      		onClick: function (event, status) {
      			allow_deficit = !allow_deficit;
      		},
      		text: {
        		enabled: false,
        		disabled: false
      		},
      		style: {
        		enabled: 'primary',
        		disabled: false
      		}
    	}).off();

    	var questions = {
				a: "Juvenile crime has been increasing in our beautiful city. What should we do?"
				//b: "test"
		};
		var responses = {
			"Hire more police": "Make our schools better"
			//b: "testanswer":"testanswer2"
		};

		$('#question-btn').click(function wizard(e, ui){
			jQuery.each(questions, function(){
				$('div.question').html(this);
			//jQuery.each(responses, function(option1, option2){
			//	$('id.question-btn').html("<button class='btn'>"+option1+"</button>"+"<button class='btn'>"+option2+"</button>")
			//});
		//console.log($('div.question').html());
		//});
			});
		});


	</script>

  </body>
</html>
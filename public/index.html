<!DOCTYPE html>
<html lang="en">
  <head>
	<meta charset="utf-8">
    <title>CityBuilder</title>
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/bootstrap-responsive.min.css">
	<link rel="stylesheet" href="css/custom-theme/jquery-ui-1.8.16.custom.css">
	<link rel="stylesheet" href="css/custom-theme/jquery.ui.1.8.16.ie.css">
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4/leaflet.css">
	<link rel="stylesheet" href="/css/style.css">
	<link href="/css/bootstrap-toggle-animated.css" rel="stylesheet">
  </head>
  <body>
    <div id="page" style="padding: 2em;">
	
    	<div id="map"></div>

	    		<div class="row" id="overlay">
	    		<div class="span3">
	    		<p>Allow Over-budgeting?</p>
	    		<div class='toggle basic' data-enabled="YES" data-disabled="NO" data-toggle="toggle">
	            <input type="checkbox" value="1" name="myCheckbox" class="checkbox" checked="checked" />
	            <label class="check" for="myCheckbox"></label>
	          	</div>
    			
				<div>
					<h2>Line Items</h2>

					<div data-budget_categories-key="a" id="slider"></div>
		      		<div id="slider-cost">Safety: <span></span></div>

					<div data-budget_categories-key="b" id="slider-1"></div>
					<div id="slider-1-cost">Infrastructure: <span></span></div>

					<div data-budget_categories-key="c" id="slider-2"></div>
					<div id="slider-2-cost">Recreation: <span></span></div>

					<div data-budget_categories-key="d" id="slider-3"></div>
					<div id="slider-3-cost">Education: <span></span></div>
				</div>

		      	<div>
					<h2>Income</h2>
					<div id="total-slider"></div>
					<div id="total-slider-cost">Income: <span></span></div>
				</div>

		      	<div>
					<h2>Totals</h2>
					<div id="total-budget-cost">Expenditures: <span></span></div>
					<div id="total-discrepancy">Discrepancy: <span></span></div>
				</div>

     		</div>
  		</div>

    </div>
    <script type="text/javascript" src="js/jquery-1.8.0.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.23.custom.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.4/leaflet.js"></script>
    <script src="js/bootstrap-toggle.js"></script>
	<script>
		var map = L.map('map').setView([35.035, -85.209], 12);
		L.tileLayer(
			'http://{s}.tile.cloudmade.com/c80639c0bd60485e919561593e8c98ee/997/256/{z}/{x}/{y}.png', 
			{
    			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>',
    			maxZoom: 18
			}).addTo(map);

		var polygon = 	L.polygon(
			[
				[35.060,-85.309],
				[35.072,-85.309], 
				[35.076,-85.303],
				[35.083,-85.295],
				[35.092,-85.286], 
				[35.112,-85.269], 
				[35.116,-85.260], 
				[35.119,-85.257], 
				[35.118,-85.248], 
				[35.109,-85.252], 
				[35.105,-85.235],
				[35.101,-85.251], 
				[35.098,-85.259], 
				[35.094,-85.268],
				[35.087,-85.277],
				[35.078,-85.281], 
				[35.068,-85.280],
				[35.062,-85.282], 
				[35.057,-85.292], 
				[35.060,-85.308]
			]).addTo(map).bindPopup("I'm District 2. Hooray!");

		var budget_init = 1000,
			budget_categories = {
				a: 100,
				b: 50,
				c: 250,
				d: 150
			},
			$dependents = $('[id^=slider]').filter(':not([id$=cost])');

			$dependents.each(function(){
				var $slider = $(this);
				$slider.slider({
		        	range: 'min',
					min: 1,
					max: budget_init,
					value: budget_categories[$slider.data('budget_categories-key')],
					slide: updateLineItem,
					create: updateLineItem
		    	});
			});
		
		function updateLineItem( e, ui )
		{
			var $slider = $(this),
				value = ui.value || ( budget_categories[$slider.data('budget_categories-key')] || 0);
			
			$( '#' + $slider.attr('id') + '-cost span' ).text( '$' + value );
			
			updateExpenditures( e, ui );
		}

		function updateIncome( e, ui )
		{
			var $slider = $('#total-slider'),
				value = ui.value || budget_init;
			
			$( '#' + $slider.attr('id') + '-cost span' ).text( '$' + value );
			
			updateMaxValues( e, ui );

			updateDiscrepancy();
		};

		function updateExpenditures( e, ui )
		{
			var total = 0,
				income = parseInt($( '#total-slider-cost span' ).text().replace('$',''),10),
				difference;
		
			$dependents.each(function(){
				total += parseInt($(this).slider('value'),10);
			});
			$('#total-budget-cost span').text( '$' + total );
			if (typeof income == "number" && typeof total == "number"){
				difference = income - total;
				if (!toggleStatus && difference < 0) {
					reduceLineItems(difference);
				}
			}
			updateDiscrepancy();
		}

		function updateDiscrepancy()
		{
			var diff = parseInt($('#total-slider-cost span').text().replace('$',''), 10) - parseInt($('#total-budget-cost span').text().replace('$',''), 10);
			$('#total-discrepancy span').text('$'+diff).css("color", (diff < 0 ? "red" : "black" ));
		}

		function updateMaxValues( e, ui )
		{
			$dependents.slider('option','max',ui.value);
			$dependents
				.each(function(){
					$(this).slider('option','value',$(this).slider('value'));
				});
			
		}

		function reduceLineItems(difference)
		{
			var count = $dependents.length;
			var reduceBy = Math.ceil(difference/count);
			console.log(count, reduceBy);
			var complete = 0;
			while (complete != difference) 
			{
				$dependents.each(function()
				{
					var $slider = $(this),
						total = total < 0 ? 0 : $slider.slider('value')+reduceBy;
					$(this).slider('option','value',total);
					$( '#' + $slider.attr('id') + '-cost span' ).text( '$' + total );
					complete += reduceBy;
				});
			}
			break;				
		}


		$('#total-slider').slider({
			range: 'min',
			min: $dependents.length,
			max: 5000,
			value: budget_init,
			slide: updateIncome,
			create: updateIncome
		});

		var toggleStatus = true;
		$('.basic').toggle({
      		onClick: function (event, status) {
      			toggleStatus = !toggleStatus;
      		},
      		text: {
        		enabled: false, // Change the enabled disabled text on the fly ie: 'ENABLED'
        		disabled: false // and for 'DISABLED'
      		},
      		style: {
        		enabled: 'primary', // default button styles like btn-primary, btn-info, btn-warning just remove the btn- part.
        		disabled: false // same goes for this, primary, info, warning, danger, success. 
      		}
    	});
	</script>

  </body>
</html>